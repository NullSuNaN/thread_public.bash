# Thread Public Variables for Bash (`tpub`)

SEE [THIS](docs/containers.md#tpubreleaseall)!

A Bash library that implements **thread-public, synchronized variables**.

This allows multiple Bash threads(background jobs / subshells) to safely **share variables** through a single host process.

---

## Features

* Thread-safe shared variables in pure Bash
* Supports Scalars, Arrays and Associative arrays (maps).
* No external dependencies (uses `mkfifo`, `sleep`, file descriptors)
* Deterministic locking (single host thread)
* Works across subshells and background jobs

---

## Installation

Save the file as `./thread_public.bash` and source it in the main thread:

```bash
source ./thread_public.bash
```

> The library will refuse to load if `THREAD_PUBLIC_INCLUDED` already exists.

---

## API Reference

The host thread may output some error message to `stderr`(`&2`) when an illegal expression is sent to it, you can use `2>/dev/null` when doing `tpubCreate`.

If you discovered a way to crash the host thread via the following APIs, please [report it](issues/new?title=Host%20Thread%20Crash%20With%20PUT_IT_HERE)

---

### Containers

A container would hold your thread public variables, containers is the base of the following operations.

Each container would consume two file descriptors, and each container have a GIL.

You must always release all the container when the process ends.

[Container Document](docs/containers.md)

---

### Operations

The thread public variables is stored separately, so you need to use the following operations to read/write them:

+ [Get Operations](docs/get.md)
+ [Set Operations](docs/set.md)
+ [Lock Operations](docs/lock.md)

A list of operations that creates new threads generated by ChatGPT:
+ [operations that creates threads.md](docs/operations%20that%20creates%20threads.md)

---

### Expressions

Expressions is an easy way to do the operations, but since we can't just use the original bash expression, it may be unsafe.

[Expressions Document](docs/containers.md)

---
 
## Example

```bash
#!/usr/bin/env bash

trap '' SIGINT
source ./thread_public.bash

tpubCreate 10 11 main

tpubSet main counter 0

tasks=()
for i in {1..5}; do
  (
    echo "TASK $i"
    local val=
    tpubLock main counter
    tpubGetAs val main counter
    tpubSet main counter "$((val + 1))"
    tpubUnlock main counter
    echo "TASK $i END"
  ) &
  tasks[${#tasks[@]}]="$!"
done
echo "waiting"
wait "${tasks[@]}"

echo "Final value:" "$(tpubGet main counter)"

tpubReleaseAll
```

---

## Implementation Notes

* Compatible with Bash 5+
* **DO NOT** do any of the following things:
```bash
readonly locks curVar tpubMapFd1 tpubMapFd2 __tpub__Result
THREAD_PUBLIC_INCLUDED=anything
```